<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>SiliconCloud AI 助手</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root{--bg:#f5f6fa;--user:#0078ff;--ai:#e5e5ea;--text:#111;}
*{box-sizing:border-box;}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:var(--bg);display:flex;flex-direction:column;height:100vh;}
header{background:#fff;border-bottom:1px solid #ddd;padding:.5rem 1rem;font-size:.9rem;display:flex;justify-content:space-between;align-items:center;}
header button{background:var(--user);color:#fff;border:none;padding:.3rem .6rem;border-radius:4px;cursor:pointer;}
header button:disabled{background:#aaa;cursor:not-allowed;}
#chat{flex:1;overflow-y:auto;padding:1rem;}
.msg{max-width:70%;margin:.5rem;padding:.6rem .8rem;border-radius:1rem;line-height:1.4;white-space:pre-wrap;word-break:break-word;}
.user{background:var(--user);color:#fff;align-self:flex-end;margin-left:auto;}
.ai{background:var(--ai);color:var(--text);}
.thinking{display:flex;justify-content:center;margin:.3rem 0;}
.thinking div{width:6px;height:6px;margin:0 2px;background:#888;border-radius:50%;animation:dot 1.4s infinite ease-in-out both;}
.thinking div:nth-child(1){animation-delay:-0.32s;}
.thinking div:nth-child(2){animation-delay:-0.16s;}
@keyframes dot{0%,80%,100%{transform:scale(0);opacity:.5;}40%{transform:scale(1);opacity:1;}}
#bottom{display:flex;border-top:1px solid #ddd;background:#fff;}
#input{flex:1;border:none;padding:.8rem 1rem;font-size:1rem;outline:none;}
#sendBtn{border:none;background:var(--user);color:#fff;padding:0 1.2rem;cursor:pointer;}
#sendBtn:disabled{background:#aaa;cursor:not-allowed;}
</style>
</head>
<body>

<header>
  <span id="creditInfo">积分：0</span>
  <button id="checkInBtn" disabled>今日已签到</button>
</header>

<div id="chat"></div>

<div id="bottom">
  <input id="input" placeholder="输入问题，按 Enter 发送（每条消耗 1 积分）" autocomplete="off" />
  <button id="sendBtn">发送</button>
</div>

<script>
(() => {
  /* ===== 工具封装 ===== */
  const $ = id => document.getElementById(id);
  const chat    = $('chat');
  const input   = $('input');
  const sendBtn = $('sendBtn');
  const creditInfo = $('creditInfo');
  const checkInBtn = $('checkInBtn');

  const CHAT_KEY   = 'sf-chat';
  const CREDIT_KEY = 'sf-credit';
  const CHECK_KEY  = 'sf-check-date';

  const MAX_CHAT = 10;          // 最多保存 10 条对话
  const DAILY_CREDIT = 5;       // 每天签到 5 积分

  let messages = JSON.parse(localStorage.getItem(CHAT_KEY) || '[]');
  let credit   = +(localStorage.getItem(CREDIT_KEY) || 0);

  /* ===== 签到逻辑 ===== */
  function todayStr() { return new Date().toLocaleDateString(); }
  function initCheckIn() {
    const last = localStorage.getItem(CHECK_KEY);
    if (last === todayStr()) {
      checkInBtn.disabled = true;
      checkInBtn.textContent = '今日已签到';
    } else {
      checkInBtn.disabled = false;
      checkInBtn.textContent = '签到领积分';
      checkInBtn.onclick = () => {
        credit += DAILY_CREDIT;
        localStorage.setItem(CREDIT_KEY, credit);
        localStorage.setItem(CHECK_KEY, todayStr());
        updateCreditUI();
        initCheckIn();          // 刷新按钮状态
      };
    }
  }

  /* ===== 积分 & 对话 UI ===== */
  function updateCreditUI() {
    creditInfo.textContent = `积分：${credit}`;
  }

  function saveMessages() {
    // 仅保留最近 MAX_CHAT 条
    if (messages.length > MAX_CHAT) messages = messages.slice(-MAX_CHAT);
    localStorage.setItem(CHAT_KEY, JSON.stringify(messages));
  }

  function renderChat() {
    chat.innerHTML = '';
    messages.forEach(m => appendBubble(m.role, m.text));
    chat.scrollTop = chat.scrollHeight;
  }

  function appendBubble(role, text) {
    const div = document.createElement('div');
    div.className = `msg ${role}`;
    div.textContent = text;
    chat.appendChild(div);
  }

  async function typeWriter(el, text, speed = 30) {
    el.textContent = '';
    el.classList.add('typing');
    for (let i = 0; i <= text.length; i++) {
      el.textContent = text.slice(0, i);
      await new Promise(r => setTimeout(r, speed));
    }
    el.classList.remove('typing');
  }

  /* ===== 发送消息 ===== */
  const API_KEY  = 'sk-egpaeaztksryiwbebciehvacervfrlhgctuuwpmmbmacrubb'; // ← 替换
  const BASE_URL = 'https://api.siliconflow.cn';
  const MODEL_ID = 'THUDM/GLM-Z1-9B-0414';

  async function send() {
    const text = input.value.trim();
    if (!text) return;
    if (credit <= 0) {
      alert('积分不足，请先签到或明天再来！');
      return;
    }

    credit -= 1;
    localStorage.setItem(CREDIT_KEY, credit);
    updateCreditUI();

    messages.push({ role: 'user', text });
    saveMessages();
    renderChat();

    input.value = '';
    sendBtn.disabled = true;

    const aiBubble = document.createElement('div');
    aiBubble.className = 'msg ai';
    const thinking = document.createElement('div');
    thinking.className = 'thinking';
    ['','',''].forEach(() => thinking.appendChild(document.createElement('div')));
    aiBubble.appendChild(thinking);
    chat.appendChild(aiBubble);
    chat.scrollTop = chat.scrollHeight;

    try {
      const res = await fetch(`${BASE_URL}/v1/chat/completions`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${API_KEY}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          model: MODEL_ID,
          messages: [
            { role: 'system', content: '你是一个乐于助人的 AI 助手。' },
            { role: 'user', content: text }
          ],
          temperature: 0.7,
          max_tokens: 1024,
          stream: false
        })
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const reply = data.choices?.[0]?.message?.content || '(无返回)';
      thinking.remove();
      await typeWriter(aiBubble, reply);
      messages.push({ role: 'ai', text: reply });
    } catch (e) {
      thinking.remove();
      aiBubble.textContent = '❌ 调用失败：' + e.message;
      messages.push({ role: 'ai', text: aiBubble.textContent });
    } finally {
      saveMessages();
      sendBtn.disabled = false;
    }
  }

  /* ===== 初始化 ===== */
  updateCreditUI();
  initCheckIn();
  renderChat();

  sendBtn.onclick = send;
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !sendBtn.disabled) send();
  });
})();
</script>

</body>
</html>
