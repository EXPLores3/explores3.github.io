<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>SiliconCloud AI 助手</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root{--bg:#f5f6fa;--user:#0078ff;--ai:#e5e5ea;--text:#111;}
*{box-sizing:border-box;}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:var(--bg);display:flex;flex-direction:column;height:100vh;}
#chat{flex:1;overflow-y:auto;padding:1rem;}
.msg{max-width:70%;margin:.5rem;padding:.6rem .8rem;border-radius:1rem;line-height:1.4;white-space:pre-wrap;word-break:break-word;}
.user{background:var(--user);color:#fff;align-self:flex-end;margin-left:auto;}
.ai{background:var(--ai);color:var(--text);}
.typing::after{content:'▋';animation:blink 1s infinite;}
@keyframes blink{50%{opacity:0;}}
#bottom{display:flex;border-top:1px solid #ddd;background:#fff;}
#input{flex:1;border:none;padding:.8rem 1rem;font-size:1rem;outline:none;}
#sendBtn{border:none;background:var(--user);color:#fff;padding:0 1.2rem;cursor:pointer;}
#sendBtn:disabled{background:#8ab4f8;cursor:not-allowed;}
</style>
</head>
<body>

<div id="chat"></div>

<div id="bottom">
  <input id="input" placeholder="输入问题，按 Enter 发送" autocomplete="off" />
  <button id="sendBtn">发送</button>
</div>

<script>
(() => {
  const chat    = document.getElementById('chat');
  const input   = document.getElementById('input');
  const sendBtn = document.getElementById('sendBtn');

  const STORAGE_KEY = 'sf-chat';
  let messages = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  render();

  // SiliconCloud 配置
  const API_KEY   = 'sk-egpaeaztksryiwbebciehvacervfrlhgctuuwpmmbmacrubb';        // ← 替换为你的 sk-xxx
  const BASE_URL  = 'https://api.siliconflow.cn';
  const MODEL_ID  = 'Qwen/Qwen3-8B';  // 可换成 Qwen/Qwen2.5-7B-Instruct 等

  async function send() {
    const text = input.value.trim();
    if (!text) return;
    addMessage('user', text);
    input.value = '';
    sendBtn.disabled = true;

    try {
      const reply = await callSiliconCloud(text);
      addMessage('ai', reply);
    } catch (e) {
      addMessage('ai', '❌ 调用失败：' + e.message);
    } finally {
      sendBtn.disabled = false;
    }
  }

  function addMessage(role, text) {
    messages.push({ role, text });
    render();
    save();
  }

  function render() {
    chat.innerHTML = '';
    messages.forEach(m => appendBubble(m.role, m.text));
    chat.scrollTop = chat.scrollHeight;
  }

  function appendBubble(role, text) {
    const div = document.createElement('div');
    div.className = `msg ${role}`;
    div.textContent = text;
    chat.appendChild(div);
  }

  /* 打字机效果 */
  async function typeWriter(element, text, speed = 30) {
    element.textContent = '';
    element.classList.add('typing');
    for (let i = 0; i <= text.length; i++) {
      element.textContent = text.slice(0, i);
      await new Promise(r => setTimeout(r, speed));
    }
    element.classList.remove('typing');
  }

  /* 真正调用 SiliconCloud Chat API */
  async function callSiliconCloud(prompt) {
    const body = {
      model: MODEL_ID,
      messages: [
        { role: 'system', content: '你是一个乐于助人的 AI 助手。' },
        { role: 'user',   content: prompt }
      ],
      temperature: 0.7,
      max_tokens: 1024,
      stream: false
    };

    const res = await fetch(`${BASE_URL}/v1/chat/completions`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${API_KEY}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });

    if (!res.ok) {
      const msg = await res.text();
      throw new Error(`HTTP ${res.status}: ${msg}`);
    }

    const data = await res.json();
    return data.choices?.[0]?.message?.content || '(无返回)';
  }

  function save() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
  }

  /* 事件绑定 */
  sendBtn.onclick = send;
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !sendBtn.disabled) send();
  });
})();
</script>

</body>
</html>
